# プロジェクト共通スタイルガイド

- すべてのレビューコメント・サマリは **日本語** で記述してください。
- **同一論点は代表箇所のみ**にコメントし、重複指摘を避けてください。
- 方針上の不一致は **提案** として記載し、強制しないでください。
- レビューの最後に **上位 5 件の優先課題サマリ** を付けてください。

---

## 0. このリポジトリの前提
- 目的: **Playwright による E2E / コンポーネントテスト学習と実践**
- 主技術: **TypeScript + Playwright Test**
- 対象ブラウザ/環境: `chromium`（必要に応じて `firefox`/`webkit` をプロジェクトに追加）
- 実行ポリシー（既定想定）:
  - `trace: 'on-first-retry'`, `screenshot: 'only-on-failure'`, `video: 'retain-on-failure'`
  - CI では `retries > 0`、ローカルは `retries = 0`
  - `forbidOnly: true` で `test.only` のコミットを防止
  - `use.baseURL` を活用し URL 直書きを排除

---

## 1. コーディング規約（言語横断）
- **命名**: クラス/型は `PascalCase`、関数/変数は `camelCase`、定数は `UPPER_SNAKE_CASE`。テストファイルは `*.spec.ts` で統一。
- **フォーマット**: インデント 2 スペース、行長 100–120、末尾スペース禁止。
- **コメント**: 「何をしたか」より **「なぜ」** を補足。公開的ユーティリティは JSDoc。
- **依存関係**: 未使用依存を削除。セキュリティアップデートを追従。
- **テスト**: 変更点に対して **ユニット/コンポーネント/統合**いずれかを必ず追加。副作用とエッジケース（空/境界/タイムアウト）を網羅。

---

## 2. Playwright 固有ルール
### 2.1 ロケータ指針（優先度）
1) **アクセシビリティロール**・ラベル系: `getByRole`, `getByLabel`, `getByPlaceholder`  
2) **テキスト（安定時のみ）**: `getByText`  
3) **テストID**: `getByTestId`（アプリ側に `data-testid` を付与）  
4) **最終手段**: CSS/XPath の脆いセレクタ  
> 例
```ts
await page.getByRole('button', { name: '保存' }).click();
await page.getByTestId('user-menu').getByRole('menuitem', { name: '設定' }).click();
```

* `nth()` 連発やクラス名依存はフレークの温床。安定識別子を優先。
* プロジェクト全体で **`data-testid` の命名規約** を統一（`feature-element[-state]` など）。Playwright の `testIdAttribute` 変更は `playwright.config.ts` で管理。

### 2.2 オートウェイトとアサーション

* 明示的な `waitForTimeout` は **禁止**（やむを得ない場合は根拠をコメント）。
* `expect(locator).toBeVisible()` / `toHaveText()` / `toHaveURL()` などの **オートウェイト系マッチャ** を活用。
* **状態遷移**はアクション直後にアサートで確定させる（クリック → 成功トーストの表示など）。

### 2.3 フィクスチャとテスト設計

* 共有初期化は **テストフィクスチャ** で表現。`page/context` 以外の責務（API クライアント、テストデータ、認証状態）を切り出す。
* **テストの独立性**: 各テストは **新規コンテキスト**で実行（既定の `page`/`context` を使い回さない）。
* 認証は `storageState` を発行して **ログインの重複**を避ける（生成は別スペック or globalSetup）。

### 2.4 Page Object Model（POM）

* 画面/機能単位で **PageObject** を定義。**ドメイン語彙**でメソッドを命名（`loginAs`, `addToCart`, `proceedToCheckout`）。
* PageObject 内部のみがロケータを知る。テストケースから **生 DOM セレクタの露出を禁止**。
* 共通動作は **BasePage** 等へ集約し重複排除。

### 2.5 ネットワーク・データ

* 外部依存は **`route` モック**で安定化（第三者 API、非決定的データ、レート制限回避）。
* テストデータは **固定/最小限**。削除や副作用を伴う操作は**専用環境**かモックで隔離。

### 2.6 トレース・アーティファクト・リトライ

* 失敗時の診断用に **Trace（`on-first-retry`）/ スクショ / 動画** を有効化。
* CI では **`retries` を有効化**、ローカルでは 0。トレースは失敗テストのみ収集。
* フレーク排除を優先し、**リトライは最終手段**。リトライ導入時は原因チケットを添付。

### 2.7 タグ付け・注釈・並列性

* `test.describe` / `test.step` で論理構造を明確化。
* スモーク/回帰/長時間などに **タグ運用**（`--grep`）を想定。
* 並列実行は **データ競合・共有資源**（ユーザー/注文ID 等）を避ける設計に。

---

## 3. セキュリティ（優先度高）

* シークレット直書き禁止（環境変数/シークレット管理）。
* PII/機密のログ出力を禁止。
* 認証後でも **権限制御**を明示的に検証（UI/バックエンド双方）。
* 依存の脆弱性チェックを定期実行。
